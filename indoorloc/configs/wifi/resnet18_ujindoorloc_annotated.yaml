# ============================================================
# IndoorLoc 配置文件 - ResNet18 + UJIndoorLoc
# ============================================================
# 这是一个带详细注释的配置模板，帮助你理解每个参数的含义。
#
# 使用方法:
#   python tools/train.py configs/wifi/resnet18_ujindoorloc.yaml
#   python tools/train.py configs/wifi/resnet18_ujindoorloc.yaml --train.lr 5e-4
#
# 快速开始 (Python):
#   import indoorloc as iloc
#   train, test = iloc.load_dataset('ujindoorloc')
#   model = iloc.create_model('resnet18', dataset=train)
#   model.fit(train, epochs=50)
# ============================================================

# ------------------------------------------------------------
# 配置继承 (_base_)
# ------------------------------------------------------------
# 使用 _base_ 可以继承其他配置文件，避免重复
# 子配置会覆盖父配置中的同名字段
_base_:
  - ../_base_/models/resnet.yaml      # 继承 ResNet 基础配置
  - ../_base_/schedules/schedule_1x.yaml  # 继承训练计划 (100 epochs)

# ============================================================
# 数据集配置 (dataset)
# ============================================================
# UJIndoorLoc: 西班牙 Jaume I 大学收集的 WiFi 指纹数据集
# - 3栋建筑，5层楼
# - 训练集 19,937 样本，测试集 1,111 样本
# - 520 个 WiFi 接入点 (WAPs)
dataset:
  type: UJIndoorLocDataset
  num_waps: 520          # WiFi 接入点数量 (UJIndoorLoc 固定为 520)
                         # 其他数据集: Tampere=489, SODIndoorLoc=varies
  num_floors: 5          # 楼层数 (UJIndoorLoc: 0-4 共5层)
  num_buildings: 3       # 建筑数 (UJIndoorLoc: 3栋建筑)
  download: true         # 首次运行自动下载数据集
                         # 下载位置: ~/.cache/indoorloc/datasets/

# ============================================================
# 模型配置 (model)
# ============================================================
model:
  type: DeepLocalizer    # 深度学习定位器 (端到端训练)
                         # 传统方法可用: KNNLocalizer, WKNNLocalizer

  # ----------------------------------------------------------
  # Backbone (特征提取器)
  # ----------------------------------------------------------
  # Backbone 负责从原始 RSSI 信号中提取特征
  # 我们使用 timm 库，支持 700+ 预训练模型
  backbone:
    type: TimmBackbone   # 使用 timm 库的预训练模型
    model_name: resnet18 # 模型名称
                         # ┌────────────────────────────────────────┐
                         # │ 推荐选择:                              │
                         # │ - resnet18: 平衡精度和速度 (推荐)      │
                         # │ - resnet34: 更深，精度略高             │
                         # │ - efficientnet_b0: 更高效，精度更好    │
                         # │ - mobilenetv3_small: 最快，适合部署    │
                         # │ - vit_tiny_patch16_224: Transformer    │
                         # └────────────────────────────────────────┘
    pretrained: true     # 使用 ImageNet 预训练权重
                         # true (强烈推荐): 收敛快，精度高
                         # false: 从零开始训练，需要更多数据和时间
    input_type: '1d'     # 输入数据类型
                         # '1d': RSSI 指纹 (向量)
                         # '2d': CSI 矩阵 (图像)

  # ----------------------------------------------------------
  # Head (预测头)
  # ----------------------------------------------------------
  # Head 负责将 Backbone 提取的特征映射到最终输出
  head:
    type: HybridHead     # 混合预测头
                         # ┌────────────────────────────────────────┐
                         # │ 可选类型:                              │
                         # │ - HybridHead: 坐标+楼层+建筑 (推荐)    │
                         # │ - RegressionHead: 仅坐标回归           │
                         # │ - ClassificationHead: 仅分类           │
                         # │ - HierarchicalHead: 层次化预测         │
                         # └────────────────────────────────────────┘
    num_coords: 2        # 坐标维度 (2 = x, y)
                         # 3D 定位可设为 3 (x, y, z)
    hidden_dims:         # 全连接层维度 (从 backbone 输出到最终预测)
      - 256              # 第一层: backbone输出 → 256
      - 128              # 第二层: 256 → 128 → 输出
                         # 更深的网络: [512, 256, 128]
                         # 更浅的网络: [128]
    dropout: 0.5         # Dropout 比例 (防止过拟合)
                         # ┌────────────────────────────────────────┐
                         # │ 调参建议:                              │
                         # │ - 数据量少 (<5000): 0.5-0.7            │
                         # │ - 数据量中 (5000-20000): 0.3-0.5       │
                         # │ - 数据量大 (>20000): 0.1-0.3           │
                         # └────────────────────────────────────────┘
    num_floors: 5        # 楼层分类数 (需与数据集一致)
    num_buildings: 3     # 建筑分类数 (需与数据集一致)

# ============================================================
# 训练配置 (train)
# ============================================================
train:
  epochs: 100            # 训练轮数
                         # ┌────────────────────────────────────────┐
                         # │ 调参建议:                              │
                         # │ - 快速实验: 20-50                      │
                         # │ - 正常训练: 100-200                    │
                         # │ - 精细调优: 300+                       │
                         # │ 配合 early_stopping 使用，防止过拟合   │
                         # └────────────────────────────────────────┘
  batch_size: 64         # 批次大小
                         # ┌────────────────────────────────────────┐
                         # │ 调参建议:                              │
                         # │ - GPU 显存 4GB: 32                     │
                         # │ - GPU 显存 8GB: 64                     │
                         # │ - GPU 显存 16GB+: 128-256              │
                         # │ - CPU 训练: 16-32                      │
                         # │ 较大的 batch_size 训练更稳定           │
                         # └────────────────────────────────────────┘
  lr: 0.001              # 学习率 (最重要的超参数!)
                         # ┌────────────────────────────────────────┐
                         # │ 调参建议:                              │
                         # │ - 预训练模型: 1e-3 ~ 5e-4              │
                         # │ - 从零训练: 1e-2 ~ 1e-3                │
                         # │ - 精细调优: 1e-4 ~ 1e-5                │
                         # │                                        │
                         # │ 常见问题:                              │
                         # │ - loss 不下降: lr 太小，尝试增大       │
                         # │ - loss 震荡: lr 太大，尝试减小         │
                         # │ - loss 爆炸 (NaN): lr 过大             │
                         # └────────────────────────────────────────┘
  weight_decay: 0.0001   # L2 正则化 (防止过拟合)
                         # 推荐范围: 1e-4 ~ 1e-5
                         # 过拟合时增大，欠拟合时减小
  early_stopping: 10     # 早停: 验证集连续 N 轮无改善则停止
                         # 设为 null 禁用早停
  fp16: true             # 混合精度训练
                         # true (推荐): 加速 2 倍，节省显存
                         # false: 精度略高，但更慢
                         # 注意: 需要 CUDA GPU 支持
  device: null           # 训练设备
                         # null: 自动选择 (推荐)
                         # 'cuda': 强制使用 GPU
                         # 'cpu': 强制使用 CPU
                         # 'mps': Apple Silicon GPU
  num_workers: 0         # 数据加载进程数
                         # 0: 主进程加载 (调试时使用)
                         # 4-8: 多进程加载 (训练时使用)
  pin_memory: true       # 锁页内存 (GPU 训练时加速数据传输)

# ============================================================
# 评估指标 (evaluation)
# ============================================================
evaluation:
  metrics:
    - type: MeanPositionError      # 平均定位误差 (米) - 主要指标
                                   # 越小越好，SOTA 约 2-3m
    - type: MedianPositionError    # 中位定位误差 (米)
                                   # 对异常值更鲁棒
    - type: FloorAccuracy          # 楼层识别准确率 (%)
                                   # 越高越好，SOTA 约 99%
    - type: BuildingAccuracy       # 建筑识别准确率 (%)
                                   # 越高越好，SOTA 约 100%

# ============================================================
# 输出目录 (work_dir)
# ============================================================
work_dir: work_dirs/resnet18_ujindoorloc
# 训练产物保存位置:
# - checkpoints/: 模型权重
# - logs/: 训练日志
# - config.yaml: 配置备份
